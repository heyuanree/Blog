---
title: Windows Exploit
tags:
  - PWN
  - Win
categories: []
date: 2017-08-15 23:01:45
---

## 基础知识

### PE/COFF文件格式

![思维导图](http://images2015.cnblogs.com/blog/928323/201604/928323-20160424150039054-1771063095.png)

#### DOS header

在中有一个MZ signature，事实上这个MZ signature是DOS文件的一个16bit的数字，表示这个DOS文件同样可以运行在MZ系统上（DOS的一个后续版本）

#### PE FILE HEADER

中有一个EntryPoint用来指示文件的入口点，同样的在ELF文件格式中也有这么一个东西来指示入口点。
DATADirectory在`WINNT.H`中的定义如下
```
#define IMAGE_DIRECTORY_ENTRY_EXPORT         0 导出表  
#define IMAGE_DIRECTORY_ENTRY_IMPORT         1 导入表   
#define IMAGE_DIRECTORY_ENTRY_RESOURCE       2 资源目录  
#define IMAGE_DIRECTORY_ENTRY_EXCEPTION      3 异常目录  
#define IMAGE_DIRECTORY_ENTRY_SECURITY       4 安全目录  
#define IMAGE_DIRECTORY_ENTRY_BASERELOC          5 重定位基本表  
#define IMAGE_DIRECTORY_ENTRY_DEBUG      6 调试目录  
#define IMAGE_DIRECTORY_ENTRY_COPYRIGHT      7 描术字串  
#define IMAGE_DIRECTORY_ENTRY_GLOBALPTR      8 机器值  
#define IMAGE_DIRECTORY_ENTRY_TLS        9 TLS目录  
#define IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10 载入配值目录  
#define IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT       11 绑定输入表  
#define IMAGE_DIRECTORY_ENTRY_IAT        12 导入地址表  
#define IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13 延迟载入描述  
#define IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR     14 COM信息  

```
用LoadPE等工具即可展示。
<!--more-->
#### Section Table

在中是关于文件代码与数据的信息，类似与ELF格式中的节信息。

#### Import Address Table(IAT)

导入地址表，类似与ELF格式中的.plt.got表，用来将DLL动态链接到运行中的程序中去，DLL的实际内存地址被写在这个表中。注意是**只读**的。

#### Export Address Table

引出表类似与ELF格式中的ret2dl-resolve的利用方法中的.rel.dyn表，这个表中记录了导入dll中的一些函数名用来定位该函数。同样注意也是**只读**的。

### 一些重要的DLL库

#### ntdll.dll

用户层与内核层的接口函数。
这个库中提供了一些windows Naive(原生) API。
驻留在写保护页中，进程间共享一个基址。
ntdll.dll是Windows系统从ring3到ring0的入口。位于Kernel32.dll和user32.dll中的所有win32 API 最终都是调用ntdll.dll中的函数实现的。ntdll.dll中的函数使用SYSENTRY进入ring0，函数的实现实体在ring0中。

#### kernel32.dll

导入ntdll.dll文件，提供Windows API的接口。驻留在写保护页中，进程间共享一个基址。
（所以猜测这个kernel32.dll和ntdll.dll都是系统启动时就加载在内存中了？待考证）

#### mscrtxxx.dll

Microsoft C Runtime Library。类似于Glibc。功能也和Glibc一样，提供一些标准库。

### Windows利用工具

+ Cygwin
+ [Pwintools（pwntools的一个简单实现）](https://www.xctf.org.cn/library/details/7ffeb1efce2a01e95f3d20cd9146179063305ee2/)
+ Process Explorer
+ VS Developer Command Prompt
+ Windbg
+ IDA
+ OD/x64dbg

### Window漏洞缓解技术

#### 通用缓解技术

+ DEP相当于linux下的NX
+ ASLR
+ CFG(Control Flow Guard)执行流保护

![BlackHat2010](http://images2015.cnblogs.com/blog/928323/201604/928323-20160424163101913-972693786.png)

#### DEP

+ 相当于Linux中的NX

+ Bypass
	+ ROP
    + JIT Page, VirtualProtect etc
    + Disable DEP for the process(NtSetInformationProcess)设置进程结构KPROCESS中相关标志位![设置相关标志位](http://images2015.cnblogs.com/blog/928323/201604/928323-20160424164039163-1082373018.png)

#### ASLR

+ 与Linux上的ASLR稍有不同
	+ PE映像基址每次系统启动时不同
    + TEB/PEB/heap/stack每次进程启动时不同
    + 同一个dll（某些，如ntdll.dll，kernel32.dll）的基址以第一次加载时固定，多个进程共享一个基址

+ Bypass
	+ 地址信息泄露，可以通过pwn其他的进程
    + brute-force (win7	x64,	win10	x86)
    + Attack Non-ASLR images or top down alloc(win7)
    + 堆喷射/JIT
    + [Modifying the BSTR length/null terminator & Modifying the Array object](https://www.fireeye.com/blog/threat-research/2013/10/aslr-bypass-apocalypse-in-lately-zero-day-exploits.html)

#### [CFG](http://101.96.10.27/sjc1-te-ftp.trendmicro.com/assets/wp/exploring-control-flow-guard-in-windows10.pdf)

+ 所有的间接调用都会由一个事前定义的只读的bitmap来检查
+ 攻击虚表将成为历史（ppt上这里暂时不理解，应该是说所有的虚表调用都是会由CFG检查）
+ Bypass
	+ [Overwrite Guard CF Check Function Pointer](https://www.blackhat.com/docs/us-15/materials/us-15-Zhang-Bypass-Control-Flow-Guard-Comprehensively.pdf)
    + 覆写CFG未保护的地址（return address, SEH handler, etc.）
    + 覆写CFG禁用模块
    + [COOP++](http://syssec.rub.de/media/emma/veroeffentlichungen/2015/03/28/COOP-Oakland15.pdf)

### 基于栈的缓解技术

+ GS
+ SafeSEH
+ SEHOP![GS](http://images2015.cnblogs.com/blog/928323/201604/928323-20160424150111601-1948331326.png)

#### GS

类似于Linux中的Canary

+ Bypass
	+ corrupt SEH(x86)
    + Stack	underflow向前溢出
    + nonlinear	write不顺序写，单打返回地址
    + emm...没看懂下面两个大佬写的是什么


## 参考资料

+ [WinPWN](https://blog.pwnhub.cn/download/01/WinPWN.pdf)
+ [Windows平台下的漏洞利用与防护](http://www.cnblogs.com/flycat-2016/p/5426910.html)
+ [Windows漏洞利用技术总结](http://www.cnblogs.com/Danny-Wei/p/3766337.html)
+ [XMan笔记](https://www.xctf.org.cn/library/details/cbf49988610a48428addf58156ebed1434d162d5/)
+ [Win10安全特性之执行流保护](http://www.freebuf.com/articles/security-management/58373.html)
